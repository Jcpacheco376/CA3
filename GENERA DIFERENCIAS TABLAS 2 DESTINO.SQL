-- SCRIPT B (V5 - FINAL): COMPARADOR INTELIGENTE (PK SAFE)
-- Ejecutar en Base de Datos DESTINO
SET NOCOUNT ON;

DECLARE @SchemaJson NVARCHAR(MAX) = N'
    <?json [{"Type":"Columns","Table":"CatalogoDepartamentos","ColName":"DepartamentoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoDepartamentos","ColName":"CodRef","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoDepartamentos","ColName":"Nombre","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoDepartamentos","ColName":"Abreviatura","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoDepartamentos","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"IX","Table":"CatalogoDepartamentos","ColName":"UQ__Catalogo__84823DEFB2F98238","ColList":"CodRef","IsUnique":true},{"Type":"IX","Table":"CatalogoDepartamentos","ColName":"IX_CatalogoDepartamentos_CodRef","ColList":"CodRef","IsUnique":false},{"Type":"PK","Table":"CatalogoDepartamentos","ColName":"PK__Catalogo__66BB0E3E7076A78A","ColList":"DepartamentoId"},{"Type":"Columns","Table":"CatalogoEstablecimientos","ColName":"EstablecimientoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstablecimientos","ColName":"CodRef","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoEstablecimientos","ColName":"Nombre","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstablecimientos","ColName":"Abreviatura","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoEstablecimientos","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"PK","Table":"CatalogoEstablecimientos","ColName":"PK_CatalogoEstablecimientos","ColList":"EstablecimientoId"},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"EstatusId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"Abreviatura","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"Descripcion","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"Tipo","DataType":"nvarchar","MaxLen":100,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"ColorUI","DataType":"nvarchar","MaxLen":100,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"ValorNomina","DataType":"decimal","MaxLen":5,"Prec":3,"Scale":2,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"VisibleSupervisor","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"DiasRegistroFuturo","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"EsFalta","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"EsRetardo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"EsEntradaSalidaIncompleta","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"EsAsistencia","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"PermiteComentario","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"Esdefault","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"EsDescanso","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoEstatusAsistencia","ColName":"SinHorario","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":true},{"Type":"IX","Table":"CatalogoEstatusAsistencia","ColName":"UQ_CatalogoEstatusAsistencia_Abreviatura","ColList":"Abreviatura","IsUnique":true},{"Type":"PK","Table":"CatalogoEstatusAsistencia","ColName":"PK_CatalogoEstatusAsistencia","ColList":"EstatusId"},{"Type":"Columns","Table":"CatalogoGruposNomina","ColName":"GrupoNominaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoGruposNomina","ColName":"CodRef","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoGruposNomina","ColName":"Nombre","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoGruposNomina","ColName":"Abreviatura","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoGruposNomina","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"IX","Table":"CatalogoGruposNomina","ColName":"UQ__Catalogo__84823DEF9B46BAE2","ColList":"CodRef","IsUnique":true},{"Type":"PK","Table":"CatalogoGruposNomina","ColName":"PK__Catalogo__21FBC54587866023","ColList":"GrupoNominaId"},{"Type":"Columns","Table":"CatalogoHorarios","ColName":"HorarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorarios","ColName":"CodRef","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoHorarios","ColName":"Abreviatura","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorarios","ColName":"Nombre","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorarios","ColName":"MinutosTolerancia","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorarios","ColName":"ColorUI","DataType":"nvarchar","MaxLen":100,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorarios","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorarios","ColName":"EsRotativo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorarios","ColName":"Turno","DataType":"char","MaxLen":1,"Prec":0,"Scale":0,"IsNull":true},{"Type":"IX","Table":"CatalogoHorarios","ColName":"UQ__Catalogo__84823DEF251EDF4B","ColList":"CodRef","IsUnique":true},{"Type":"PK","Table":"CatalogoHorarios","ColName":"PK__Catalogo__BB881B7EFA5F410B","ColList":"HorarioId"},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"HorarioDetalleId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"HorarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"DiaSemana","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"EsDiaLaboral","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"HoraEntrada","DataType":"time","MaxLen":5,"Prec":16,"Scale":7,"IsNull":true},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"HoraSalida","DataType":"time","MaxLen":5,"Prec":16,"Scale":7,"IsNull":true},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"HoraInicioComida","DataType":"time","MaxLen":5,"Prec":16,"Scale":7,"IsNull":true},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"HoraFinComida","DataType":"time","MaxLen":5,"Prec":16,"Scale":7,"IsNull":true},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"MinutosAntesEntrada","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoHorariosDetalle","ColName":"MinutosDespuesSalida","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"FK","Table":"CatalogoHorariosDetalle","ColName":"FK__HorarioDe__Horar__2AA05119","RefTable":"CatalogoHorarios","ColList":"HorarioId"},{"Type":"IX","Table":"CatalogoHorariosDetalle","ColName":"UQ_Horario_DiaSemana","ColList":"HorarioId,DiaSemana","IsUnique":true},{"Type":"PK","Table":"CatalogoHorariosDetalle","ColName":"PK__HorarioD__3A5CF92BAE676948","ColList":"HorarioDetalleId"},{"Type":"Columns","Table":"CatalogoNivelesAutorizacion","ColName":"ConfigId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoNivelesAutorizacion","ColName":"RoleId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoNivelesAutorizacion","ColName":"NivelSeveridad","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"FK","Table":"CatalogoNivelesAutorizacion","ColName":"FK_ConfigNivel_Rol","RefTable":"Roles","ColList":"RoleId"},{"Type":"PK","Table":"CatalogoNivelesAutorizacion","ColName":"PK__Catalogo__C3BC335C69A7C5DE","ColList":"ConfigId"},{"Type":"Columns","Table":"CatalogoPuestos","ColName":"PuestoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoPuestos","ColName":"CodRef","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoPuestos","ColName":"Nombre","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoPuestos","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"IX","Table":"CatalogoPuestos","ColName":"UQ__Catalogo__84823DEF6B0844E9","ColList":"CodRef","IsUnique":true},{"Type":"IX","Table":"CatalogoPuestos","ColName":"IX_CatalogoPuestos_CodRef","ColList":"CodRef","IsUnique":false},{"Type":"PK","Table":"CatalogoPuestos","ColName":"PK__Catalogo__F7F6C6045872112F","ColList":"PuestoId"},{"Type":"Columns","Table":"CatalogoTiposIncidencia","ColName":"TipoIncidenciaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoTiposIncidencia","ColName":"Nombre","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoTiposIncidencia","ColName":"Descripcion","DataType":"nvarchar","MaxLen":510,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CatalogoTiposIncidencia","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CatalogoTiposIncidencia","ColName":"Codigo","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":false},{"Type":"IX","Table":"CatalogoTiposIncidencia","ColName":"UQ_CatalogoTiposIncidencia_Codigo","ColList":"Codigo","IsUnique":true},{"Type":"PK","Table":"CatalogoTiposIncidencia","ColName":"PK_CatalogoTiposIncidencia","ColList":"TipoIncidenciaId"},{"Type":"Columns","Table":"Checadas","ColName":"ChecadaId","DataType":"bigint","MaxLen":8,"Prec":19,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Checadas","ColName":"EmpleadoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Checadas","ColName":"FechaHora","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":false},{"Type":"Columns","Table":"Checadas","ColName":"Checador","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":true},{"Type":"FK","Table":"Checadas","ColName":"FK_Checadas_Empleado","RefTable":"Empleados","ColList":"EmpleadoId"},{"Type":"IX","Table":"Checadas","ColName":"IX_Checadas_Procesamiento","ColList":"EmpleadoId,FechaHora","IsUnique":false},{"Type":"PK","Table":"Checadas","ColName":"PK__Checadas__E09D0857F5FF0142","ColList":"ChecadaId"},{"Type":"Columns","Table":"CierresNomina","ColName":"CierreId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CierresNomina","ColName":"FechaInicio","DataType":"date","MaxLen":3,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CierresNomina","ColName":"FechaFin","DataType":"date","MaxLen":3,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CierresNomina","ColName":"FechaCierre","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"CierresNomina","ColName":"UsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"CierresNomina","ColName":"Comentarios","DataType":"nvarchar","MaxLen":510,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"CierresNomina","ColName":"Estado","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"PK","Table":"CierresNomina","ColName":"PK__CierresN__0BAD3FBAA06FC761","ColList":"CierreId"},{"Type":"Columns","Table":"ConfiguracionIncidencias","ColName":"ConfigId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"ConfiguracionIncidencias","ColName":"CodigoRegla","DataType":"varchar","MaxLen":50,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"ConfiguracionIncidencias","ColName":"EstatusSistemaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"ConfiguracionIncidencias","ColName":"EstatusManualId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"ConfiguracionIncidencias","ColName":"NivelSeveridad","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"ConfiguracionIncidencias","ColName":"RequiereAutorizacion","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"ConfiguracionIncidencias","ColName":"MensajeError","DataType":"nvarchar","MaxLen":510,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"ConfiguracionIncidencias","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"ConfiguracionIncidencias","ColName":"TipoIncidenciaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"FK","Table":"ConfiguracionIncidencias","ColName":"FK_ConfiguracionIncidencias_Tipo","RefTable":"CatalogoTiposIncidencia","ColList":"TipoIncidenciaId"},{"Type":"FK","Table":"ConfiguracionIncidencias","ColName":"FK_ConfigInc_Sistema","RefTable":"CatalogoEstatusAsistencia","ColList":"EstatusSistemaId"},{"Type":"FK","Table":"ConfiguracionIncidencias","ColName":"FK_ConfigInc_Manual","RefTable":"CatalogoEstatusAsistencia","ColList":"EstatusManualId"},{"Type":"FK","Table":"ConfiguracionIncidencias","ColName":"FK_Config_TipoIncidencia","RefTable":"CatalogoTiposIncidencia","ColList":"TipoIncidenciaId"},{"Type":"IX","Table":"ConfiguracionIncidencias","ColName":"UQ_ReglasCruce","ColList":"EstatusSistemaId,EstatusManualId","IsUnique":true},{"Type":"PK","Table":"ConfiguracionIncidencias","ColName":"PK__Configur__C3BC335CA6310596","ColList":"ConfigId"},{"Type":"Columns","Table":"ConfiguracionSistema","ColName":"ConfigId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"ConfiguracionSistema","ColName":"ConfigKey","DataType":"nvarchar","MaxLen":100,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"ConfiguracionSistema","ColName":"ConfigValue","DataType":"nvarchar","MaxLen":100,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"ConfiguracionSistema","ColName":"Descripcion","DataType":"nvarchar","MaxLen":510,"Prec":0,"Scale":0,"IsNull":true},{"Type":"IX","Table":"ConfiguracionSistema","ColName":"UQ__Configur__4A3067849B34E941","ColList":"ConfigKey","IsUnique":true},{"Type":"PK","Table":"ConfiguracionSistema","ColName":"PK__Configur__C3BC335C714F25CA","ColList":"ConfigId"},{"Type":"Columns","Table":"Empleados","ColName":"EmpleadoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Empleados","ColName":"CodRef","DataType":"nvarchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Empleados","ColName":"NombreCompleto","DataType":"nvarchar","MaxLen":300,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Empleados","ColName":"FechaNacimiento","DataType":"date","MaxLen":3,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"FechaIngreso","DataType":"date","MaxLen":3,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"DepartamentoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"GrupoNominaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"PuestoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"HorarioIdPredeterminado","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Empleados","ColName":"Sexo","DataType":"nchar","MaxLen":2,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"NSS","DataType":"nvarchar","MaxLen":40,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"CURP","DataType":"nvarchar","MaxLen":40,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"RFC","DataType":"nvarchar","MaxLen":40,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"Imagen","DataType":"varbinary","MaxLen":-1,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"EstablecimientoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Empleados","ColName":"Pim","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"FK","Table":"Empleados","ColName":"FK__Empleados__Depar__22FF2F51","RefTable":"CatalogoDepartamentos","ColList":"DepartamentoId"},{"Type":"FK","Table":"Empleados","ColName":"FK__Empleados__Grupo__23F3538A","RefTable":"CatalogoGruposNomina","ColList":"GrupoNominaId"},{"Type":"FK","Table":"Empleados","ColName":"FK__Empleados__Puest__24E777C3","RefTable":"CatalogoPuestos","ColList":"PuestoId"},{"Type":"FK","Table":"Empleados","ColName":"FK__Empleados__Horar__25DB9BFC","RefTable":"CatalogoHorarios","ColList":"HorarioIdPredeterminado"},{"Type":"IX","Table":"Empleados","ColName":"UQ__Empleado__84823DEF9F934FB5","ColList":"CodRef","IsUnique":true},{"Type":"IX","Table":"Empleados","ColName":"IX_Empleados_Depto_Grupo","ColList":"NombreCompleto,Activo,DepartamentoId,GrupoNominaId","IsUnique":false},{"Type":"PK","Table":"Empleados","ColName":"PK__Empleado__958BE910924FBBD4","ColList":"EmpleadoId"},{"Type":"Columns","Table":"FichaAsistencia","ColName":"FichaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"FichaAsistencia","ColName":"EmpleadoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"FichaAsistencia","ColName":"Fecha","DataType":"date","MaxLen":3,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"FichaAsistencia","ColName":"HorarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"HoraEntrada","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"HoraSalida","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"EstatusChecadorId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"EstatusManualId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"Estado","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"FichaAsistencia","ColName":"IncidenciaActivaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"ModificadoPorUsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"FechaModificacion","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"Comentarios","DataType":"nvarchar","MaxLen":510,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"VentanaInicio","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia","ColName":"VentanaFin","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"FK","Table":"FichaAsistencia","ColName":"FK_Ficha_Empleado","RefTable":"Empleados","ColList":"EmpleadoId"},{"Type":"FK","Table":"FichaAsistencia","ColName":"FK_Ficha_EstChecador","RefTable":"CatalogoEstatusAsistencia","ColList":"EstatusChecadorId"},{"Type":"FK","Table":"FichaAsistencia","ColName":"FK_Ficha_EstManual","RefTable":"CatalogoEstatusAsistencia","ColList":"EstatusManualId"},{"Type":"IX","Table":"FichaAsistencia","ColName":"UQ_Ficha_EmpleadoFecha","ColList":"EmpleadoId,Fecha","IsUnique":true},{"Type":"PK","Table":"FichaAsistencia","ColName":"PK__FichaAsi__0C37E560105A632F","ColList":"FichaId"},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"HistorialId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"FichaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"EmpleadoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"Fecha","DataType":"date","MaxLen":3,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"HorarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"HoraEntrada","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"HoraSalida","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"EstatusChecadorId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"EstatusManualId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"Estado","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"IncidenciaActivaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"ModificadoPorUsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"FechaModificacion","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"Comentarios","DataType":"nvarchar","MaxLen":510,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"VentanaInicio","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"VentanaFin","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"FechaCambioHistorial","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"FichaAsistencia_Historial","ColName":"Accion","DataType":"char","MaxLen":1,"Prec":0,"Scale":0,"IsNull":true},{"Type":"PK","Table":"FichaAsistencia_Historial","ColName":"PK__FichaAsi__9752068F028CF193","ColList":"HistorialId"},{"Type":"Columns","Table":"HorariosTemporales","ColName":"HorarioTemporalId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"HorariosTemporales","ColName":"EmpleadoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"HorariosTemporales","ColName":"Fecha","DataType":"date","MaxLen":3,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"HorariosTemporales","ColName":"HorarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"HorariosTemporales","ColName":"ModificadoPorUsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"HorariosTemporales","ColName":"FechaModificacion","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"HorariosTemporales","ColName":"TipoAsignacion","DataType":"char","MaxLen":1,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"HorariosTemporales","ColName":"HorarioDetalleId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"HorariosTemporales","ColName":"EstatusConflictivo","DataType":"nvarchar","MaxLen":510,"Prec":0,"Scale":0,"IsNull":true},{"Type":"FK","Table":"HorariosTemporales","ColName":"FK__HorariosT__Horar__25876198","RefTable":"CatalogoHorarios","ColList":"HorarioId"},{"Type":"FK","Table":"HorariosTemporales","ColName":"FK__HorariosT__Emple__24933D5F","RefTable":"Empleados","ColList":"EmpleadoId"},{"Type":"IX","Table":"HorariosTemporales","ColName":"UQ_Empleado_Fecha_HorarioTemp","ColList":"EmpleadoId,Fecha","IsUnique":true},{"Type":"PK","Table":"HorariosTemporales","ColName":"PK__Horarios__9322C0005E84F59D","ColList":"HorarioTemporalId"},{"Type":"Columns","Table":"Incidencias","ColName":"IncidenciaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Incidencias","ColName":"EmpleadoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Incidencias","ColName":"Fecha","DataType":"date","MaxLen":3,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Incidencias","ColName":"TipoIncidenciaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Incidencias","ColName":"EstatusChecadorId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Incidencias","ColName":"EstatusManualId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Incidencias","ColName":"Estado","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Incidencias","ColName":"AsignadoAUsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Incidencias","ColName":"NivelSeveridad","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Incidencias","ColName":"RequiereAutorizacion","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Incidencias","ColName":"FechaCreacion","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"Incidencias","ColName":"FechaCierre","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"Incidencias","ColName":"ResueltoPorUsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"FK","Table":"Incidencias","ColName":"FK_Incidencias_Empleados","RefTable":"Empleados","ColList":"EmpleadoId"},{"Type":"FK","Table":"Incidencias","ColName":"FK_Incidencias_EstChecador","RefTable":"CatalogoEstatusAsistencia","ColList":"EstatusChecadorId"},{"Type":"FK","Table":"Incidencias","ColName":"FK_Incidencias_EstSupervisor","RefTable":"CatalogoEstatusAsistencia","ColList":"EstatusManualId"},{"Type":"FK","Table":"Incidencias","ColName":"FK_Incidencias_Tipo","RefTable":"CatalogoTiposIncidencia","ColList":"TipoIncidenciaId"},{"Type":"FK","Table":"Incidencias","ColName":"FK_Incidencias_UsuarioAsignado","RefTable":"Usuarios","ColList":"AsignadoAUsuarioId"},{"Type":"PK","Table":"Incidencias","ColName":"PK__Incidenc__E41133E60AB95301","ColList":"IncidenciaId"},{"Type":"Columns","Table":"IncidenciasAutorizaciones","ColName":"AutorizacionId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"IncidenciasAutorizaciones","ColName":"IncidenciaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"IncidenciasAutorizaciones","ColName":"RolRequeridoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"IncidenciasAutorizaciones","ColName":"UsuarioAutorizoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"IncidenciasAutorizaciones","ColName":"Estatus","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"IncidenciasAutorizaciones","ColName":"FechaRespuesta","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"FK","Table":"IncidenciasAutorizaciones","ColName":"FK_Autorizaciones_Incidencia","RefTable":"Incidencias","ColList":"IncidenciaId"},{"Type":"FK","Table":"IncidenciasAutorizaciones","ColName":"FK_Autorizaciones_Rol","RefTable":"Roles","ColList":"RolRequeridoId"},{"Type":"FK","Table":"IncidenciasAutorizaciones","ColName":"FK_Autorizaciones_Usuario","RefTable":"Usuarios","ColList":"UsuarioAutorizoId"},{"Type":"PK","Table":"IncidenciasAutorizaciones","ColName":"PK__Incidenc__08107FD56FFE8427","ColList":"AutorizacionId"},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"BitacoraId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"IncidenciaId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"UsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"FechaMovimiento","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"Accion","DataType":"varchar","MaxLen":50,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"Comentario","DataType":"nvarchar","MaxLen":-1,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"EstadoNuevo","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"AsignadoA_Anterior","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"AsignadoA_Nuevo","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"IncidenciasBitacora","ColName":"EstadoAnterior","DataType":"varchar","MaxLen":20,"Prec":0,"Scale":0,"IsNull":true},{"Type":"FK","Table":"IncidenciasBitacora","ColName":"FK_Bitacora_Incidencia","RefTable":"Incidencias","ColList":"IncidenciaId"},{"Type":"PK","Table":"IncidenciasBitacora","ColName":"PK__Incidenc__7ACF9B38FAFE5FDE","ColList":"BitacoraId"},{"Type":"Columns","Table":"JON","ColName":"ID","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"JON","ColName":"JSON","DataType":"varchar","MaxLen":-1,"Prec":0,"Scale":0,"IsNull":true},{"Type":"PK","Table":"JON","ColName":"PK__JON__3214EC27B952011D","ColList":"ID"},{"Type":"Columns","Table":"Permisos","ColName":"PermisoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Permisos","ColName":"NombrePermiso","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Permisos","ColName":"Descripcion","DataType":"nvarchar","MaxLen":510,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Permisos","ColName":"Activo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":true},{"Type":"PK","Table":"Permisos","ColName":"PK__Permisos__96E0C7231F42298A","ColList":"PermisoId"},{"Type":"Columns","Table":"Roles","ColName":"RoleId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Roles","ColName":"NombreRol","DataType":"nvarchar","MaxLen":100,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Roles","ColName":"Descripcion","DataType":"nvarchar","MaxLen":510,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Roles","ColName":"FechaCreacion","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":true},{"Type":"IX","Table":"Roles","ColName":"UQ__Roles__4F0B537F43A3B8D4","ColList":"NombreRol","IsUnique":true},{"Type":"PK","Table":"Roles","ColName":"PK__Roles__8AFACE1A619C55FA","ColList":"RoleId"},{"Type":"Columns","Table":"RolesPermisos","ColName":"RoleId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"RolesPermisos","ColName":"PermisoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Usuarios","ColName":"UsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Usuarios","ColName":"NombreUsuario","DataType":"nvarchar","MaxLen":100,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Usuarios","ColName":"PasswordHash","DataType":"varbinary","MaxLen":-1,"Prec":0,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Usuarios","ColName":"NombreCompleto","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Usuarios","ColName":"Email","DataType":"nvarchar","MaxLen":200,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Usuarios","ColName":"EstaActivo","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Usuarios","ColName":"FechaCreacion","DataType":"datetime","MaxLen":8,"Prec":23,"Scale":3,"IsNull":false},{"Type":"Columns","Table":"Usuarios","ColName":"Theme","DataType":"nvarchar","MaxLen":100,"Prec":0,"Scale":0,"IsNull":true},{"Type":"Columns","Table":"Usuarios","ColName":"AnimationsEnabled","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Usuarios","ColName":"DebeCambiarPassword","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"Usuarios","ColName":"TokenVersion","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"IX","Table":"Usuarios","ColName":"UQ__Usuarios__6B0F5AE0D39B3F06","ColList":"NombreUsuario","IsUnique":true},{"Type":"PK","Table":"Usuarios","ColName":"PK__Usuarios__2B3DE7B818448526","ColList":"UsuarioId"},{"Type":"Columns","Table":"UsuariosDepartamentos","ColName":"UsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"UsuariosDepartamentos","ColName":"DepartamentoId","DataType":"char","MaxLen":5,"Prec":0,"Scale":0,"IsNull":false},{"Type":"FK","Table":"UsuariosDepartamentos","ColName":"FK__UsuariosD__Usuar__11158940","RefTable":"Usuarios","ColList":"UsuarioId"},{"Type":"PK","Table":"UsuariosDepartamentos","ColName":"PK__Usuarios__DD56575B9E26A88A","ColList":"UsuarioId,DepartamentoId"},{"Type":"Columns","Table":"UsuariosEstablecimientos","ColName":"UsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"UsuariosEstablecimientos","ColName":"EstablecimientoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"PK","Table":"UsuariosEstablecimientos","ColName":"PK_UsuariosEstablecimientos","ColList":"UsuarioId,EstablecimientoId"},{"Type":"Columns","Table":"UsuariosGruposNomina","ColName":"UsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"UsuariosGruposNomina","ColName":"GrupoNominaId","DataType":"char","MaxLen":5,"Prec":0,"Scale":0,"IsNull":false},{"Type":"FK","Table":"UsuariosGruposNomina","ColName":"FK__UsuariosG__Usuar__0E391C95","RefTable":"Usuarios","ColList":"UsuarioId"},{"Type":"PK","Table":"UsuariosGruposNomina","ColName":"PK__Usuarios__69225BEC368169AA","ColList":"UsuarioId,GrupoNominaId"},{"Type":"Columns","Table":"UsuariosPuestos","ColName":"UsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"UsuariosPuestos","ColName":"PuestoId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"PK","Table":"UsuariosPuestos","ColName":"PK_UsuariosPuestos","ColList":"UsuarioId,PuestoId"},{"Type":"Columns","Table":"UsuariosRoles","ColName":"UsuarioId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"UsuariosRoles","ColName":"RoleId","DataType":"int","MaxLen":4,"Prec":10,"Scale":0,"IsNull":false},{"Type":"Columns","Table":"UsuariosRoles","ColName":"EsPrincipal","DataType":"bit","MaxLen":1,"Prec":1,"Scale":0,"IsNull":false},{"Type":"PK","Table":"UsuariosRoles","ColName":"PK__Usuarios__93924B593806F1F0","ColList":"UsuarioId,RoleId"}]?>
	';

-- =========================================================
-- 1. LIMPIEZA AUTOMÁTICA DE TAGS XML
-- =========================================================
SET @SchemaJson = REPLACE(@SchemaJson, '<?json ', '');
-- Reemplazamos el cierre ?> por vacío. A veces viene con saltos de línea.
SET @SchemaJson = REPLACE(@SchemaJson, '?>', ''); 

-- 2. CARGAR JSON
IF OBJECT_ID('tempdb..#MasterSchema') IS NOT NULL DROP TABLE #MasterSchema;

SELECT * INTO #MasterSchema
FROM OPENJSON(@SchemaJson)
WITH (
    [Type] NVARCHAR(20),
    [Table] NVARCHAR(128),
    [ColName] NVARCHAR(128),
    [DataType] NVARCHAR(128),
    [MaxLen] SMALLINT,
    [Prec] TINYINT,
    [Scale] TINYINT,
    [IsNull] BIT,
    [Def] NVARCHAR(MAX),
    [RefTable] NVARCHAR(128),
    [ColList] NVARCHAR(MAX),
    [IsUnique] BIT
);

DECLARE @SqlStatement NVARCHAR(MAX) = '';

PRINT '--------------------------------------------------';
PRINT '--- 1. TABLAS Y COLUMNAS';
PRINT '--------------------------------------------------';

-- A) TABLAS NUEVAS
DECLARE @NewTable NVARCHAR(128);
DECLARE cur_tables CURSOR FOR 
SELECT DISTINCT s.[Table] FROM #MasterSchema s LEFT JOIN sys.tables t ON s.[Table] = t.name 
WHERE s.[Type] = 'Columns' AND t.name IS NULL;

OPEN cur_tables;
FETCH NEXT FROM cur_tables INTO @NewTable;
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @SqlStatement = 'CREATE TABLE [dbo].[' + @NewTable + '] (';
    SELECT @SqlStatement += CHAR(13) + '    [' + [ColName] + '] [' + [DataType] + ']' + 
        CASE 
            WHEN [DataType] IN ('varchar', 'nvarchar', 'char', 'nchar', 'binary', 'varbinary') THEN '(' + IIF([MaxLen]=-1,'MAX',CAST(IIF([DataType] LIKE 'n%', [MaxLen]/2, [MaxLen]) AS VARCHAR)) + ')'
            WHEN [DataType] IN ('decimal', 'numeric') THEN '(' + CAST([Prec] AS VARCHAR) + ',' + CAST([Scale] AS VARCHAR) + ')'
            ELSE ''
        END + IIF([IsNull]=1,' NULL',' NOT NULL') + ','
    FROM #MasterSchema WHERE [Table] = @NewTable AND [Type] = 'Columns';
    
    SET @SqlStatement = LEFT(@SqlStatement, LEN(@SqlStatement)-1) + CHAR(13) + ');';
    PRINT @SqlStatement; PRINT 'GO';
    FETCH NEXT FROM cur_tables INTO @NewTable;
END
CLOSE cur_tables; DEALLOCATE cur_tables;

-- B) COLUMNAS NUEVAS
DECLARE @AlterTab NVARCHAR(128), @NewCol NVARCHAR(128), @DT NVARCHAR(128), @ML SMALLINT, @PR TINYINT, @SC TINYINT, @NU BIT;
DECLARE cur_cols CURSOR FOR 
SELECT s.[Table], s.[ColName], s.[DataType], s.[MaxLen], s.[Prec], s.[Scale], s.[IsNull]
FROM #MasterSchema s
INNER JOIN sys.tables t ON s.[Table] = t.name
LEFT JOIN sys.columns c ON t.object_id = c.object_id AND s.[ColName] = c.name
WHERE s.[Type] = 'Columns' AND c.name IS NULL;

OPEN cur_cols;
FETCH NEXT FROM cur_cols INTO @AlterTab, @NewCol, @DT, @ML, @PR, @SC, @NU;
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @SqlStatement = 'ALTER TABLE [dbo].[' + @AlterTab + '] ADD [' + @NewCol + '] [' + @DT + ']';
    IF @DT IN ('varchar','nvarchar','char','nchar') SET @SqlStatement += '(' + IIF(@ML=-1,'MAX',CAST(IIF(@DT LIKE 'n%', @ML/2, @ML) AS VARCHAR)) + ')';
    ELSE IF @DT IN ('decimal','numeric') SET @SqlStatement += '(' + CAST(@PR AS VARCHAR) + ',' + CAST(@SC AS VARCHAR) + ')';
    SET @SqlStatement += IIF(@NU=1,' NULL;',' NULL; -- OJO: Se puso NULL porque la tabla existe');
    PRINT @SqlStatement; PRINT 'GO';
    FETCH NEXT FROM cur_cols INTO @AlterTab, @NewCol, @DT, @ML, @PR, @SC, @NU;
END
CLOSE cur_cols; DEALLOCATE cur_cols;

PRINT '';
PRINT '--------------------------------------------------';
PRINT '--- 2. PRIMARY KEYS (PK)';
PRINT '--------------------------------------------------';

DECLARE @PKTable NVARCHAR(128), @PKName NVARCHAR(128), @PKCols NVARCHAR(MAX);
-- Solo buscamos PKs que NO existan por nombre, PERO validaremos si la tabla ya tiene una
DECLARE cur_pk CURSOR FOR 
SELECT s.[Table], s.[ColName], s.[ColList]
FROM #MasterSchema s
LEFT JOIN sys.key_constraints kc ON s.[ColName] = kc.name
WHERE s.[Type] = 'PK' AND kc.name IS NULL;

OPEN cur_pk;
FETCH NEXT FROM cur_pk INTO @PKTable, @PKName, @PKCols;
WHILE @@FETCH_STATUS = 0
BEGIN
    -- === CAMBIO PRINCIPAL AQUI ===
    -- Verificamos si la tabla en destino YA TIENE alguna PK (aunque tenga otro nombre)
    IF EXISTS (
        SELECT 1 FROM sys.key_constraints 
        WHERE type = 'PK' AND parent_object_id = OBJECT_ID(@PKTable)
    )
    BEGIN
        PRINT '-- INFO: La tabla [' + @PKTable + '] ya tiene Primary Key. Se omite creación de: ' + @PKName;
    END
    ELSE
    BEGIN
        PRINT 'ALTER TABLE [dbo].[' + @PKTable + '] ADD CONSTRAINT [' + @PKName + '] PRIMARY KEY (' + @PKCols + ');';
        PRINT 'GO';
    END

    FETCH NEXT FROM cur_pk INTO @PKTable, @PKName, @PKCols;
END
CLOSE cur_pk; DEALLOCATE cur_pk;

PRINT '';
PRINT '--------------------------------------------------';
PRINT '--- 3. INDICES (IX)';
PRINT '--------------------------------------------------';

DECLARE @IXTable NVARCHAR(128), @IXName NVARCHAR(128), @IXCols NVARCHAR(MAX), @IsUnq BIT;
DECLARE cur_ix CURSOR FOR 
SELECT s.[Table], s.[ColName], s.[ColList], s.[IsUnique]
FROM #MasterSchema s
LEFT JOIN sys.indexes i ON s.[ColName] = i.name AND OBJECT_ID(s.[Table]) = i.object_id
WHERE s.[Type] = 'IX' AND i.name IS NULL;

OPEN cur_ix;
FETCH NEXT FROM cur_ix INTO @IXTable, @IXName, @IXCols, @IsUnq;
WHILE @@FETCH_STATUS = 0
BEGIN
    SET @SqlStatement = 'CREATE ' + IIF(@IsUnq=1, 'UNIQUE ', '') + 'INDEX [' + @IXName + '] ON [dbo].[' + @IXTable + '] (' + @IXCols + ');';
    PRINT @SqlStatement; PRINT 'GO';
    FETCH NEXT FROM cur_ix INTO @IXTable, @IXName, @IXCols, @IsUnq;
END
CLOSE cur_ix; DEALLOCATE cur_ix;

PRINT '';
PRINT '--------------------------------------------------';
PRINT '--- 4. FOREIGN KEYS (FK)';
PRINT '--------------------------------------------------';

DECLARE @FKTable NVARCHAR(128), @FKName NVARCHAR(128), @RefTab NVARCHAR(128), @LocalCols NVARCHAR(MAX);
DECLARE cur_fk CURSOR FOR 
SELECT s.[Table], s.[ColName], s.[RefTable], s.[ColList]
FROM #MasterSchema s
LEFT JOIN sys.foreign_keys fk ON s.[ColName] = fk.name
WHERE s.[Type] = 'FK' AND fk.name IS NULL;

OPEN cur_fk;
FETCH NEXT FROM cur_fk INTO @FKTable, @FKName, @RefTab, @LocalCols;
WHILE @@FETCH_STATUS = 0
BEGIN
    -- Validamos también si el FK ya existe con otro nombre (complejo, pero evitamos error obvio de nombre duplicado en catch)
    PRINT 'ALTER TABLE [dbo].[' + @FKTable + '] WITH CHECK ADD CONSTRAINT [' + @FKName + '] FOREIGN KEY(' + @LocalCols + ')';
    PRINT 'REFERENCES [dbo].[' + @RefTab + '] -- (Verificar columnas destino)';
    PRINT 'GO';
    PRINT 'ALTER TABLE [dbo].[' + @FKTable + '] CHECK CONSTRAINT [' + @FKName + ']';
    PRINT 'GO';
    
    FETCH NEXT FROM cur_fk INTO @FKTable, @FKName, @RefTab, @LocalCols;
END
CLOSE cur_fk; DEALLOCATE cur_fk;

DROP TABLE #MasterSchema;


