name: "1. Descargar y extraer zipball del commit (robusto TLS/redirect)"
  shell: powershell
  env:
    GH_TOKEN: ${{ github.token }}
    OWNER_REPO: ${{ github.repository }}
    REF: ${{ github.sha }}
  run: |
    # 1) TLS 1.2 para PowerShell 5 y mejorar estabilidad
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    [System.Net.ServicePointManager]::Expect100Continue = $false

    # 2) Paths y headers
    $zipPath = Join-Path $env:ZIP_DIR "repo.zip"
    if (Test-Path $zipPath) { Remove-Item -Path $zipPath -Force -ErrorAction SilentlyContinue }
    $url = "https://api.github.com/repos/$env:OWNER_REPO/zipball/$env:REF"
    $ua  = "actions"
    $auth= "Bearer $env:GH_TOKEN"

    # 3) Downloader preferido: curl.exe (mejor con redirects/CDN)
    $downloaded = $false
    $curl = (Get-Command curl.exe -ErrorAction SilentlyContinue)
    if ($curl) {
      & $curl.Path -L --retry 5 --retry-delay 2 ^
        -H "Authorization: $auth" ^
        -H "X-GitHub-Api-Version: 2022-11-28" ^
        -H "User-Agent: $ua" ^
        -o "$zipPath" "$url"
      if (Test-Path $zipPath) { $downloaded = $true }
    }

    # 4) Fallback 1: BITS (tolerante a redes)
    if (-not $downloaded) {
      try {
        Start-BitsTransfer -Source $url -Destination $zipPath -Description "repo.zip" -DisplayName "repo.zip" -RetryInterval 5 -ErrorAction Stop
        $downloaded = (Test-Path $zipPath)
      } catch {
        # ignorar, probaremos IWR
      }
    }

    # 5) Fallback 2: Invoke-WebRequest con redirecciones/timeout
    if (-not $downloaded) {
      try {
        $headers = @{
          Authorization          = $auth
          "X-GitHub-Api-Version" = "2022-11-28"
          "User-Agent"           = $ua
        }
        Invoke-WebRequest -Uri $url -Headers $headers -OutFile $zipPath -MaximumRedirection 10 -TimeoutSec 600 -UseBasicParsing
        $downloaded = (Test-Path $zipPath)
      } catch {
        Write-Host "Invoke-WebRequest fall칩: $($_.Exception.Message)"
      }
    }

    if (-not $downloaded) {
      throw "No se pudo descargar el zip del repo."
    }

    # 6) Extraer a ruta corta y reubicar contenido
    Remove-Item -Path $env:SRC_DIR -Recurse -Force -ErrorAction SilentlyContinue
    New-Item -ItemType Directory -Force -Path $env:SRC_DIR | Out-Null
    Expand-Archive -Path $zipPath -DestinationPath $env:SRC_DIR -Force

    $inner = Get-ChildItem -LiteralPath $env:SRC_DIR | Where-Object { $_.PSIsContainer } | Select-Object -First 1
    if ($null -ne $inner) {
      Get-ChildItem -LiteralPath $inner.FullName -Force | ForEach-Object {
        Move-Item -LiteralPath $_.FullName -Destination $env:SRC_DIR -Force
      }
      Remove-Item -LiteralPath $inner.FullName -Recurse -Force
    }

    # 7) Validaci칩n b치sica
    if (-not (Test-Path (Join-Path $env:SRC_DIR 'package.json'))) {
      Write-Host "Advertencia: no se encontr칩 package.json en SRC_DIR; verifique estructura."
    }
